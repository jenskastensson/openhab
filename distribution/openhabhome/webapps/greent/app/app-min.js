var oph_greenT_version='1.1.0';var oph_greenT_build='1003';var oph_openHAB_version='not known';var oph_update_available=false;var oph_update_version;var oph_update_build;var oph_update_info;var g_AllValues='All Values';var firstload=true;var detectedTransport=null;var socket=$.atmosphere;var fallbackProtocol=null;var current_widgets;function subscribe(location){var request={url:location,maxRequest:256,timeout:59000,attachHeadersAsQueryString:true,executeCallbackBeforeReconnect:false,transport:force_transport,fallbackTransport:fallbackProtocol,headers:{'Accept':'application/json'}};request.onError=function(response){}
request.onOpen=function(response){detectedTransport=response.transport;}
request.onMessage=function(response){if(response.status==200){var data=response.responseBody;if(data.length>0){try{updateWidgets(Ext.JSON.decode(data));}catch(e){}}}};socket.subscribe(request);}
function unsubscribe(){socket.unsubscribe();}
function getOpenhabVersion(){Ext.Ajax.request({url:'/static/version',success:function(response){oph_openHAB_version=response.responseText;getUpdateServer();}});}
function getUpdateServer(){Ext.Ajax.request({url:'/greent/app/updates_server.cfg',success:function(response){checkForUpdates(response.responseText);},failure:function(response){alert('Error connecting update server!');}});}
function checkForUpdates(updates_srver){Ext.data.JsonP.request({url:updates_srver+'/check.php?version='+oph_greenT_build,callbackKey:'callback',success:function(result,request){if(result.status==true){oph_update_available=result.needsUpdate;oph_update_version=result.lastBuildName;oph_update_build=result.lastBuildNumber;oph_update_info=result.info;if(OpenHAB.enableUpdates=='true'){if(result.needsUpdate==true){var update_answer=confirm('GreenT UI version '+result.lastBuildName+' is available. Do you want to update now?')
if(update_answer){if(!settingsPanel){showSettingsWindow();settingsPanel.setActiveItem(2);}else{settingsPanel.setActiveItem(2);}}}}}else{alert('Error reading update server!');}}});}
function updateWidgets(result){if(Ext.isArray(result.widget)){for(var i=0 in result.widget){if(result.widget[i].type=="Frame"){if(Ext.isArray(result.widget[i].widget)){for(var k=0 in result.widget[i].widget){setWidgetData(result.widget[i].widget[k]);}}else{setWidgetData(result.widget[i].widget);}}else{setWidgetData(result.widget[i]);}}}else{setWidgetData(result.widget);}
if(deviceType!='Phone'){if(result.parent&&result.parent.id==currentLeftNavPage){setTitle(result.title);updateLeftNavMenuItem(result.id,result.title,result.icon);}else if(result.id==currentLeftNavPage){refreshTitle();}else{refreshTitle();}}else{setTitle(result.title);}}
var UIobjects={};var UInavPanel={expanded:true,text:'Left nav',children:[]};var ajax_requests=new Array();var broadCrumb=new Array();var broadCrumbText='';var newCard;var settingsPanel=null;var updateModel={};var deviceTypeCls='';var deviceType;var clickOnLeaf=false;var firstTime=true;var sitemap;var currentLeftNavPage;var leftNavPanel;var sitemapUIcontainer;var transition={type:'slide',direction:'left'};var sitemapsPanel;var icon_class="oph_icon";var icon_style="background-image:url";var oph_usepicker;var dirtySettings=false;function getLocalStoreItem(item_name,default_value){var value=localStorage.getItem(item_name);if(!value||value=="null"){return default_value;}else{return value;}}
function setTheme(){var current_theme=getLocalStoreItem('openHAB_theme','black-glass');if(OpenHAB.themes.indexOf(current_theme)==-1){current_theme='black-glass';}
theme_css_filename='./themes/'+current_theme+'/css/style.css';var theme_css=document.createElement("link");theme_css.setAttribute("rel","stylesheet");theme_css.setAttribute("type","text/css");theme_css.setAttribute("href",theme_css_filename);document.getElementsByTagName("head")[0].appendChild(theme_css);}
var ui_language=loadUILanguage();var transitions=getLocalStoreItem('openHAB_transitions','1');var force_transport=getLocalStoreItem('openHAB_transport','auto');var chart_servlet=getLocalStoreItem('openHAB_chart_servlet','chart');var g_email;var g_ip;Ext.override(Ext.data.Connection,{timeout:60000});Ext.Ajax.timeout=60000;Ext.override(Ext.data.proxy.Ajax,{timeout:60000});function loadUILanguage(){language=getLocalStoreItem('openHAB_language','en');if(language=='en'||language=='de'||language=='fr')
return language;return'en';}
var sitemapStoreLoadTries=3;var sitemapsStoreSelection=new Ext.data.Store({fields:['name','value'],autoLoad:true});var sitemapsStore=new Ext.data.Store({fields:['name','value'],autoLoad:true,listeners:{exception:function(proxy,response,op,opt){if(sitemapStoreLoadTries>0){sitemapsStore.load();sitemapStoreLoadTries--;}else{sitemapStoreLoadTries=3;alert(OpenHAB.i18n_strings[ui_language].error_server_connection);}},load:function(store,records,success){if(success){for(record in records){records[record].data.value=records[record].data.name;};sitemapStoreLoadTries=3;sitemapsStoreSelection.insert(0,[{name:'- '+OpenHAB.i18n_strings[ui_language].choose_on_startup,value:'choose'}])
sitemapsStore.each(function(record){sitemapsStoreSelection.add(record.copy());});}else{if(sitemapStoreLoadTries>0){sitemapsStore.load();sitemapStoreLoadTries--;}else{sitemapStoreLoadTries=3;alert(OpenHAB.i18n_strings[ui_language].error_server_connection);}}}},proxy:{type:'ajax',url:'/rest/sitemaps',headers:{'Accept':'application/json',},noCache:true,limitParam:undefined,startParam:undefined,pageParam:undefined,reader:{type:'json',rootProperty:'sitemap'}}});var sitemapsWindow={id:'sitemapsWindow',floating:true,centered:true,layout:'fit',scrollable:false,items:[{title:OpenHAB.i18n_strings[ui_language].interfaces,xtype:'toolbar',ui:'light',docked:'top'},{xtype:'list',store:sitemapsStore,singleSelect:true,itemTpl:'{name}',scrollable:false,listeners:{itemtap:function(view,index,target,record){sitemap=record.data.name;loadUIData(sitemap);sitemapsPanel.destroy();}}}]};function getCurrentPageId(){return broadCrumb[broadCrumb.length-1][0];}
var settingsWindow={id:'settingsWindow',floating:true,centered:true,height:420,layout:'card',items:[{scrollable:'vertical',items:[{xtype:'toolbar',ui:'light',docked:'top',items:[{xtype:'spacer'},{xtype:'label',cls:'x-title',centered:true,zIndex:0,html:OpenHAB.i18n_strings[ui_language].settings},{xtype:'spacer'},{iconCls:'delete',iconMask:true,ui:'normal',handler:function(){if(dirtySettings){new_ui_language=settingsPanel.getItems().items[0].getItems().items[2].getValue();localStorage.setItem('openHAB_device_type',settingsPanel.getItems().items[0].getItems().items[1].getValue());if(new_ui_language!=ui_language){title=OpenHAB.i18n_strings[ui_language].restart_server;msg=OpenHAB.i18n_strings[ui_language].this_will_restart_the_software;Ext.Msg.show({message:msg,title:title,buttons:null});Ext.Ajax.request({url:'/CMD?ProservLanguage='+new_ui_language,method:"GET",disableCaching:false,success:function(response){Ext.Ajax.request({url:'/rest/items/ProservLanguage/state',timeout:5000,success:function(response){if(response.responseText!=new_ui_language){title=OpenHAB.i18n_strings[ui_language].the_operation_failed;msg=OpenHAB.i18n_strings[ui_language].changing_language_failed;Ext.Msg.alert(title,msg);}else{localStorage.setItem('openHAB_language',new_ui_language);setTimeout(function(){alert(OpenHAB.i18n_strings[ui_language].need_to_restart_for_changes_to_take_effect);window.location.reload(true);},60000);}}});},failure:function(response){title=OpenHAB.i18n_strings[ui_language].timeout;msg=OpenHAB.i18n_strings[ui_language].the_operation_timed_out_waiting;Ext.Msg.alert(title,msg);}});}
else{alert(OpenHAB.i18n_strings[ui_language].need_to_restart_for_changes_to_take_effect);window.location.reload(true);}}
settingsPanel.destroy();settingsPanel=null;},}]},{xtype:'selectfield',label:OpenHAB.i18n_strings[ui_language].this_device_is,labelWidth:'40%',style:'border-bottom: 1px solid E6E6E6;',listeners:{change:function(){dirtySettings=true}},options:[{text:OpenHAB.i18n_strings[ui_language].auto_detect,value:'Auto'},{text:OpenHAB.i18n_strings[ui_language].phone,value:'Phone'},{text:OpenHAB.i18n_strings[ui_language].tablet,value:'Tablet'},{text:OpenHAB.i18n_strings[ui_language].pc,value:'Desktop'}],},{xtype:'selectfield',label:OpenHAB.i18n_strings[ui_language].interface_language,labelWidth:'40%',style:'border-bottom: 1px solid E6E6E6;',listeners:{change:function(){dirtySettings=true}}},{xtype:'button',text:OpenHAB.i18n_strings[ui_language].button_save_reset_history_data,style:'background-color:black;clear:both;margin-left:5%;margin-right:5%;margin-top:1%;height:1.8em',scope:this,id:'reset_history_data_btn',iconMask:true,handler:function(){title=OpenHAB.i18n_strings[ui_language].confirm_reset_of_history_data;msg=OpenHAB.i18n_strings[ui_language].are_you_sure_you_want_to_reset;Ext.Msg.confirm(title,msg,function(e){if(e=='yes'){Ext.getCmp('reset_history_data_btn').setDisabled(true);Ext.getCmp('reset_history_data_btn').setIconCls('time');Ext.Ajax.request({url:'/CMD?ProservBackupResetRrd=START',method:"GET",disableCaching:false,success:function(response){Ext.Ajax.request({url:'/rest/items/ProservBackupResetRrd/state',timeout:5000,success:function(response){if(response.responseText=='SUCCESS'){Ext.getCmp('reset_history_data_btn').setIconCls('check2');}
if(response.responseText.indexOf('FAILED')>=0){Ext.getCmp('reset_history_data_btn').setIconCls('warming_dotted');Ext.getCmp('reset_history_data_btn').setDisabled(false);title=OpenHAB.i18n_strings[ui_language].the_operation_failed;msg=OpenHAB.i18n_strings[ui_language].error_message_from_server;Ext.Msg.alert(title,msg+response.responseText.replace("FAILED:",""));}}});},failure:function(response){Ext.getCmp('reset_history_data_btn').setIconCls('warming_dotted');Ext.getCmp('reset_history_data_btn').setDisabled(false);title=OpenHAB.i18n_strings[ui_language].timeout;msg=OpenHAB.i18n_strings[ui_language].the_operation_timed_out_waiting;Ext.Msg.alert(title,msg);}});}});}},{xtype:'button',text:OpenHAB.i18n_strings[ui_language].button_save_history_data,style:'background-color:black;clear:both;margin-left:5%;margin-right:5%;margin-top:1%;height:1.8em',scope:this,id:'save_history_data_btn',iconMask:true,handler:function(){title=OpenHAB.i18n_strings[ui_language].button_save_history_data;msg=OpenHAB.i18n_strings[ui_language].this_will_save_a_snapshot;Ext.Msg.alert(title,msg,function(e){Ext.getCmp('save_history_data_btn').setDisabled(true);Ext.getCmp('save_history_data_btn').setIconCls('time');Ext.Ajax.request({url:'/CMD?ProservExportCsvFiles=START',method:"GET",timeout:600000,disableCaching:false,success:function(response){Ext.Ajax.request({url:'/rest/items/ProservExportCsvFiles/state',timeout:5000,success:function(response){if(response.responseText=='SUCCESS'){;}
if(response.responseText.indexOf('FAILED')>=0){Ext.getCmp('save_history_data_btn').setIconCls('warming_dotted');Ext.getCmp('save_history_data_btn').setDisabled(false);title=OpenHAB.i18n_strings[ui_language].the_operation_failed;msg=OpenHAB.i18n_strings[ui_language].error_message_from_server;Ext.Msg.alert(title,msg+response.responseText.replace("FAILED:",""));}}});},failure:function(response){Ext.getCmp('save_history_data_btn').setIconCls('warming_dotted');Ext.getCmp('save_history_data_btn').setDisabled(false);title=OpenHAB.i18n_strings[ui_language].timeout;msg=OpenHAB.i18n_strings[ui_language].the_operation_timed_out_waiting;Ext.Msg.alert(title,msg);}});Ext.Ajax.request({url:'/CMD?ProservBackupRrd=START',method:"GET",disableCaching:false,success:function(response){Ext.Ajax.request({url:'/rest/items/ProservBackupRrd/state',timeout:5000,success:function(response){if(response.responseText=='SUCCESS'){Ext.getCmp('save_history_data_btn').setIconCls('check2');}
if(response.responseText.indexOf('FAILED')>=0){Ext.getCmp('save_history_data_btn').setIconCls('warming_dotted');Ext.getCmp('save_history_data_btn').setDisabled(false);title=OpenHAB.i18n_strings[ui_language].the_operation_failed;msg=OpenHAB.i18n_strings[ui_language].error_message_from_server;Ext.Msg.alert(title,msg+response.responseText.replace("FAILED:",""));}}});},failure:function(response){Ext.getCmp('save_history_data_btn').setIconCls('warming_dotted');Ext.getCmp('save_history_data_btn').setDisabled(false);title=OpenHAB.i18n_strings[ui_language].timeout;msg=OpenHAB.i18n_strings[ui_language].the_operation_timed_out_waiting;Ext.Msg.alert(title,msg);}});});}},{xtype:'button',text:OpenHAB.i18n_strings[ui_language].button_send_history_data,style:'background-color:black;clear:both;margin-left:5%;margin-right:5%;margin-top:1%;height:1.8em',scope:this,id:'send_csv_data_btn',iconMask:true,handler:function(){title=OpenHAB.i18n_strings[ui_language].confirm_sending_history_data;msg=OpenHAB.i18n_strings[ui_language].assuming_you_have_exported_history;Ext.Msg.confirm(title,msg,function(e){if(e=='yes'){Ext.getCmp('send_csv_data_btn').setDisabled(true);Ext.getCmp('send_csv_data_btn').setIconCls('time');Ext.Ajax.request({url:'/CMD?ProservSendCsvFiles=START',method:"GET",timeout:240000,disableCaching:false,success:function(response){Ext.Ajax.request({url:'/rest/items/ProservSendCsvFiles/state',timeout:5000,success:function(response){if(response.responseText=='SUCCESS'){Ext.getCmp('send_csv_data_btn').setIconCls('check2');}
if(response.responseText.indexOf('FAILED')>=0){Ext.getCmp('send_csv_data_btn').setIconCls('warming_dotted');Ext.getCmp('send_csv_data_btn').setDisabled(false);title=OpenHAB.i18n_strings[ui_language].the_operation_failed;msg=OpenHAB.i18n_strings[ui_language].error_message_from_server;Ext.Msg.alert(title,msg+response.responseText.replace("FAILED:",""));}}});},failure:function(response){Ext.getCmp('send_csv_data_btn').setIconCls('warming_dotted');Ext.getCmp('send_csv_data_btn').setDisabled(false);title=OpenHAB.i18n_strings[ui_language].timeout;msg=OpenHAB.i18n_strings[ui_language].the_operation_timed_out_waiting;Ext.Msg.alert(title,msg);}});}});}},{xtype:'button',text:OpenHAB.i18n_strings[ui_language].button_configure_email,style:'background-color:black;clear:both;margin-left:5%;margin-right:5%;margin-top:1%;height:1.8em',scope:this,id:'configure_email_btn',iconMask:true,handler:function(){title=OpenHAB.i18n_strings[ui_language].confirm_email_title;msg=OpenHAB.i18n_strings[ui_language].confirm_email_msg;Ext.Msg.prompt(title,msg,function(buttonId,newEmail){if(buttonId=='ok'){Ext.getCmp('configure_email_btn').setDisabled(true);Ext.getCmp('configure_email_btn').setIconCls('time');Ext.Ajax.request({url:'/CMD?ProservEmail='+newEmail,method:"GET",timeout:5000,disableCaching:false,success:function(response){Ext.Ajax.request({url:'/rest/items/ProservEmail/state',timeout:5000,success:function(response){if(response.responseText.indexOf('FAILED')>=0){Ext.getCmp('configure_email_btn').setIconCls('warming_dotted');Ext.getCmp('configure_email_btn').setDisabled(false);title=OpenHAB.i18n_strings[ui_language].the_operation_failed;msg=OpenHAB.i18n_strings[ui_language].error_message_from_server;Ext.Msg.alert(title,msg+response.responseText.replace("FAILED:",""));}else{g_email=response.responseText;Ext.getCmp('configure_email_btn').setIconCls('check2');}}});},failure:function(response){Ext.getCmp('configure_email_btn').setIconCls('warming_dotted');Ext.getCmp('configure_email_btn').setDisabled(false);title=OpenHAB.i18n_strings[ui_language].timeout;msg=OpenHAB.i18n_strings[ui_language].the_operation_timed_out_waiting;Ext.Msg.alert(title,msg);}});}},null,false,g_email,null);}},{xtype:'button',text:OpenHAB.i18n_strings[ui_language].button_configure_ip,style:'background-color:black;clear:both;margin-left:5%;margin-right:5%;margin-top:1%;height:1.8em',scope:this,id:'configure_ip_btn',iconMask:true,handler:function(){title=OpenHAB.i18n_strings[ui_language].confirm_proserv_ip_title;msg=OpenHAB.i18n_strings[ui_language].confirm_proserv_ip_msg;Ext.Msg.prompt(title,msg,function(buttonId,newIP){if(buttonId=='ok'){Ext.getCmp('configure_ip_btn').setDisabled(true);Ext.getCmp('configure_ip_btn').setIconCls('time');Ext.Ajax.request({url:'/CMD?ProservIP='+newIP,method:"GET",timeout:5000,disableCaching:false,success:function(response){Ext.Ajax.request({url:'/rest/items/ProservIP/state',timeout:5000,success:function(response){if(response.responseText.indexOf('FAILED')>=0){Ext.getCmp('configure_ip_btn').setIconCls('warming_dotted');Ext.getCmp('configure_ip_btn').setDisabled(false);title=OpenHAB.i18n_strings[ui_language].the_operation_failed;msg=OpenHAB.i18n_strings[ui_language].error_message_from_server;Ext.Msg.alert(title,msg+response.responseText.replace("FAILED:",""));}else{g_ip=response.responseText;Ext.getCmp('configure_ip_btn').setIconCls('check2');}}});},failure:function(response){Ext.getCmp('configure_ip_btn').setIconCls('warming_dotted');Ext.getCmp('configure_ip_btn').setDisabled(false);title=OpenHAB.i18n_strings[ui_language].timeout;msg=OpenHAB.i18n_strings[ui_language].the_operation_timed_out_waiting;Ext.Msg.alert(title,msg);}});}},null,false,g_ip,null);}},{xtype:'button',text:OpenHAB.i18n_strings[ui_language].button_about_proserv_logview,style:'background-color:black;clear:both;margin-left:5%;margin-right:5%;margin-top:1%;height:1.8em',scope:this,handler:function(){window.open('../proserv');}},]},{cls:'oph_about_page',scrollable:'vertical',items:[{xtype:'toolbar',ui:'light',docked:'top',items:[{ui:'back',text:OpenHAB.i18n_strings[ui_language].back,handler:function(){settingsPanel.setActiveItem(0);},},{xtype:'spacer'},{xtype:'label',cls:'x-title',centered:true,zIndex:0,html:'About proServ Logview'},{xtype:'spacer'},{iconCls:'delete',iconMask:true,ui:'normal',handler:function(){settingsPanel.destroy();settingsPanel=null;},}]},{xtype:'container',cls:'oph_about_page_content',}]},{cls:'oph_update_page',scrollable:'vertical',items:[{xtype:'toolbar',ui:'light',docked:'top',items:[{ui:'back',text:OpenHAB.i18n_strings[ui_language].back,handler:function(){settingsPanel.setActiveItem(1);},},{xtype:'spacer'},{xtype:'label',cls:'x-title',centered:true,zIndex:0,html:'GreenT UI Update'},{xtype:'spacer'},{iconCls:'delete',iconMask:true,ui:'normal',handler:function(){settingsPanel.destroy();settingsPanel=null;},}]},{xtype:'container',cls:'oph_about_page_content',},{xtype:'button',text:'Update GreenT UI',scope:this,style:'margin:0.8em 5%;height:3em;',ui:'confirm',handler:function(btn){settingsPanel.getItems().items[2].getItems().items[2].destroy();sendCommand('update_greent','ON');settingsPanel.getItems().items[2].getItems().items[1].setHtml('');Ext.defer(readUpdateLog,3000,this);}}]}]};function readUpdateLog(){Ext.Ajax.request({url:'/greent/update.tmp',success:function(response){settingsPanel.getItems().items[2].getItems().items[1].setHtml(response.responseText);Ext.defer(readUpdateLog,3000,this);},failure:function(response){Ext.defer(readUpdateLog,3000,this);}});}
function loadUIData(sitemap_name){Ext.getCmp('content').setMasked({xtype:'loadmask',message:OpenHAB.i18n_strings[ui_language].loading});Ext.Ajax.request({url:'/rest/sitemaps/'+sitemap_name,headers:{'Accept':'application/json',},success:function(result_obj){try{result=Ext.JSON.decode(result_obj.responseText);}catch(error){loadUIData(sitemap_name);return;}
buildUIArray(result.homepage,UInavPanel);clearEmptyFrames();Ext.getCmp('content').unmask();broadCrumb[0]=new Array(result.homepage.id,result.homepage.title);Ext.getCmp('title').setHtml(result.homepage.title);goToPage(result.homepage.id);if(Ext.getCmp('leftPanel')){leftPanelstore.setRoot(UInavPanel);setCurrentLeftNavPage(result.homepage.id);}
clickOnLeaf=true;broadCrumb.push(["0000",g_AllValues]);goToPage("0000");setCurrentLeftNavPage("0000");Ext.getCmp('content').unmask();},failure:function(){alert(OpenHAB.i18n_strings[ui_language].error_server_connection);}});};Ext.define('LeftPanelListItem',{extend:'Ext.data.Model',config:{fields:[{name:'icon',type:'string'},{name:'text',type:'string'},{name:'page_id',type:'string'},{name:'page_label',type:'string'},{name:'name',type:'string'},]}});var leftPanelstore=new Ext.data.TreeStore({model:'LeftPanelListItem',autoLoad:false,proxy:{type:'memory',reader:{type:'json',rootProperty:'children'}}});function pushWidget(widget,container){if(widget){container.push(widget);}}
function buildUIArray(json,nav_parent){try{if(json){var container;UIobjects[json.id]=new Array();container=UIobjects[json.id];var page_data=json.widget;if(Ext.isArray(page_data)){var frame=false;for(var i in page_data){if(page_data[i].type!="Frame"){if(!frame){container.push({xtype:'fieldset',title:'',cls:['oph_fieldset',deviceTypeCls+'_fieldset','oph_clearfix']});container=container[container.length-1]['items']=new Array();frame=true;}
pushWidget(addsWidget(page_data[i].widgetId,page_data[i],container,nav_parent),container);}else if(page_data[i].type=="Frame"){frame=false;container.push({xtype:'fieldset',title:page_data[i].label,cls:['oph_fieldset',deviceTypeCls+'_fieldset','oph_clearfix']});container[container.length-1]['items']=new Array();if(Ext.isArray(page_data[i].widget)){for(var k in page_data[i].widget){pushWidget(addsWidget(page_data[i].widget[k].widgetId,page_data[i].widget[k],container[container.length-1]['items'],nav_parent),container[container.length-1]['items']);}}else{pushWidget(addsWidget(page_data[i].widget.widgetId,page_data[i].widget,container[container.length-1]['items'],nav_parent),container[container.length-1]['items']);}}}}else{if(page_data.type!="Frame"){container.push({xtype:'fieldset',title:'',cls:['oph_fieldset',deviceTypeCls+'_fieldset','oph_clearfix']});container=container[container.length-1]['items']=new Array();pushWidget(addsWidget(page_data.widgetId,page_data,container,nav_parent),container);}else if(page_data.type=="Frame"){container.push({xtype:'fieldset',title:page_data.label,cls:['oph_fieldset',deviceTypeCls+'_fieldset','oph_clearfix']});container[container.length-1]['items']=new Array();if(Ext.isArray(page_data.widget)){for(var k in page_data.widget){pushWidget(addsWidget(page_data.widget[k].widgetId,page_data.widget[k],container[container.length-1]['items'],nav_parent),container[container.length-1]['items']);}}else{pushWidget(addsWidget(page_data.widget.widgetId,page_data.widget,container[container.length-1]['items'],nav_parent),container[container.length-1]['items']);}}}}}catch(e){alert(OpenHAB.i18n_strings[ui_language].error_build_interface);}}
function clearEmptyFrames(){for(var i in UIobjects){var newArray=[];for(var k in UIobjects[i]){if(UIobjects[i][k].items.length>0){newArray.push(UIobjects[i][k]);}}
UIobjects[i]=newArray;}}
function addsWidget(id,data,container,nav_parent){var widget;var navigation_parent;if(data.type=="Switch"){if(data.item&&data.item.type=="RollershutterItem"){widget=createRollershutterWidget(data.item?data.item.name:'',data.label,data.icon)}else if(data.item&&data.item.type=="NumberItem"){widget=createButtonsWidget(data.item?data.item.name:'',data.mapping,data.label,data.icon);}else if(data.item&&data.item.type=="SwitchItem"&&data.mapping){widget=createButtonsWidget(data.item?data.item.name:'',data.mapping,data.label,data.icon);}else if(data.item&&data.item.type=="GroupItem"&&data.mapping){widget=createButtonsWidget(data.item?data.item.name:'',data.mapping,data.label,data.icon);}else{widget=createTextWidget(data.label,data.icon);}}else if(data.type=="Slider"){widget=createSliderWidget(data.item?data.item.name:'',data.label,data.icon);}else if(data.type=="Setpoint"){widget=createSetpointWidget(data.item?data.item.name:'',data.minValue,data.maxValue,data.step,data.label,data.icon);}else if(data.type=="Video"){widget=createVideoWidget(data.item?data.item.name:'',data.url,data.label,data.icon);}else if(data.type=="Webview"){widget=createWebviewWidget(data.item?data.item.name:'',data.url,data.height,data.label,data.icon);}else if(data.type=="Chart"){widget=createChartWidget(data.item?data.item.name:'',id,data.w,data.h,data.period,data.refresh,data.item?data.item.type:'',data.label,data.icon);}else if(data.type=="Text"){if(data.linkedPage){if(deviceType=="Phone"){widget=createLinkWidget(data);}else{navigation_parent=addButtonToLeftNav(id,data,nav_parent);}
buildUIArray(data.linkedPage,navigation_parent);}else{widget=createTextWidget(data.label,data.icon);}}else if(data.type=="Group"){if(deviceType=="Phone"){widget=createLinkWidget(data);}else{navigation_parent=addButtonToLeftNav(id,data,nav_parent);}
buildUIArray(data.linkedPage,navigation_parent);}else if(data.type=="Selection"){widget=createSelectionWidget(data.item?data.item.name:'',data.mapping,data.label,data.icon);}else if(data.type=="Image"){if(data.linkedPage){if(deviceType=="Phone"){widget=createImageLinkWidget(data.url,data.linkedPage.id,data.linkedPage.title);}else{navigation_parent=addButtonToLeftNav(id,data,nav_parent);widget=createImageLinkWidget(data.url,data.linkedPage.id,data.linkedPage.title);}
buildUIArray(data.linkedPage,navigation_parent);}else{widget=createImageWidget(data.url);}}else if(data.type=="Frame"){}
else{widget=createUnsupportedWidget();}
if(widget){widget.name=id;}
return widget;}
function addButtonToLeftNav(id,data,nav_parent){if(data.linkedPage){page_id=data.linkedPage.id;}else{page_id="none";}
if(page_id=="0000"&&data.widgetId=="proserv_0_0")
g_AllValues=data.label;pushWidget({icon:data.icon,text:data.label.replace(/[\[\]']+/g,''),page_id:page_id,page_label:data.label,leaf:true,name:id,id:id},nav_parent.children);nav_parent.leaf=false;nav_parent.children[nav_parent.children.length-1].children=new Array();return nav_parent.children[nav_parent.children.length-1];}
function showSettingsWindow(){if(settingsPanel){settingsPanel.destroy();settingsPanel=null;}else{settingsPanel=new Ext.Panel(settingsWindow);settingsPanel.setCls(deviceTypeCls+'_modal');settingsPanel.getItems().items[0].getItems().items[1].setValue(getLocalStoreItem('openHAB_device_type','auto'));var options_array=new Array();for(var i in OpenHAB.i18n_strings){options_array.push({text:OpenHAB.i18n_strings[i].language_name,value:i})}
settingsPanel.getItems().items[0].getItems().items[2].setOptions(options_array);settingsPanel.getItems().items[0].getItems().items[2].setValue(getLocalStoreItem('openHAB_language','en'));options_array=[];for(var i in OpenHAB.themes){options_array.push({text:OpenHAB.themes[i],value:OpenHAB.themes[i]})}
logo_width=50;if(deviceType=='Phone'){logo_width=85;}
update_link='';if(OpenHAB.enableUpdates=='true'||OpenHAB.enableUpdates=='password'){if(oph_update_available){update_link=' <i>(<a href="#" style="color:red" id="update_button">UPDATE</a>)</i>';}else{update_link=' <i>(up to date)</i>';}}
Ext.Viewport.add(settingsPanel);try{Ext.get("update_button").clearListeners();Ext.get("update_button").on("tap",function(){if(OpenHAB.enableUpdates=='password'){var password=prompt("Enter a password:","");if(password==OpenHAB.updatesPassword){settingsPanel.setActiveItem(2);}else{alert('Wrong password!');}}else if(OpenHAB.enableUpdates=='true'){settingsPanel.setActiveItem(2);}});}catch(e){}
dirtySettings=false;}}
function NavBarItemTap(list,item,index,e,data){if(data.raw.page_id=='none'){return;}
if(data.raw.leaf){if(clickOnLeaf){broadCrumb.pop();}
clickOnLeaf=true;}else{if(clickOnLeaf){broadCrumb.pop();}
clickOnLeaf=false;setCurrentLeftNavPage(data.raw.page_id);}
broadCrumb.push([data.raw.page_id,data.raw.page_label]);if(UIobjects[data.raw.page_id].length>0){goToPage(data.raw.page_id);}}
function tapHandler(btn,evt){if(btn.config.page_id=='none'){return;}
btn.addCls('selected');if(deviceType=='Phone'){broadCrumb.push([btn.config.page_id,btn.config.page_label]);transition={type:'slide',direction:'left'};goToPage(btn.config.page_id);}else{leftNav=Ext.getCmp('leftPanel').getActiveItem();index=leftNav.getStore().getAt(leftNav.getStore().find('page_id',btn.config.page_id)).data.index;leftNav.select(index,false,false);NavBarItemTap(leftNav,'',index,'',leftNav.getStore().getAt(leftNav.getStore().find('page_id',btn.config.page_id)));}}
function backPage(){if(broadCrumb.length>1){broadCrumb.pop();transition={type:'slide',direction:'right'};goToPage(broadCrumb[broadCrumb.length-1][0]);}}
function goToPage(page){newCard=new Oph.form.Panel({scrollable:'vertical',autoDestroy:true,cls:['oph_widgets_container',deviceTypeCls+'_widgets_container']});newCard.add(UIobjects[page]);if(transitions=='0'){Ext.getCmp("content").setActiveItem(newCard);}else if(transitions=='1'){Ext.getCmp("content").animateActiveItem(newCard,transition);}}
function updateWidgetsAjax(page,update_type){if(page==getCurrentPageId()){var update_type_header='';var update_type_timeout=5000;if(!update_type||update_type=='normal'){update_type_header={'Accept':'application/json'};}else if(update_type=='long-poll'){unsubscribe();subscribe('/rest/sitemaps/'+sitemap+'/'+page);return;}
for(var i=ajax_requests.length-1;i>=0;i--){if(ajax_requests.hasOwnProperty(i)){Ext.Ajax.abort(ajax_requests[i]);ajax_requests.pop();}}
req=Ext.Ajax.request({url:'/rest/sitemaps/'+sitemap+'/'+page,headers:update_type_header,disableCaching:true,timeout:update_type_timeout,failure:function(result){if(update_type=="long-poll"){updateWidgetsAjax(page,'long-poll');}else{updateWidgetsAjax(page,'normal');}},success:function(result_obj){if(result_obj.statusText=="OK"&&result_obj.responseText!=""){try{var result=Ext.JSON.decode(result_obj.responseText);}catch(exception){updateWidgetsAjax(page,'normal');return;}
updateWidgets(result);updateWidgetsAjax(page,'long-poll');}else{}}});ajax_requests.push(req);}}
function setWidgetData(widget_data){if(current_widgets[widget_data.widgetId]){current_widgets[widget_data.widgetId].setValueData(widget_data);}else{if(deviceType!="Phone"){updateLeftNavMenu(widget_data);}}}
function updateLeftNavMenuItem(page_id,title,icon){nav_store=Ext.getCmp('leftPanel').getActiveItem().getStore();index=nav_store.find('page_id',page_id);if(index!=-1){nav_store.getAt(index).set("text",title.replace(/[\[\]']+/g,''));nav_store.getAt(index).set("icon",icon);}}
function updateLeftNavMenu(updatedata){nav_store=Ext.getCmp('leftPanel').getActiveItem().getStore();index=nav_store.find('name',updatedata.widgetId);if(index!=-1){nav_store.getAt(index).set("text",updatedata.label.replace(/[\[\]']+/g,''));nav_store.getAt(index).set("icon",updatedata.icon);}}
function setProfile(){if(force_transport=='auto'){force_transport='long-polling';fallbackProtocol='websocket';if(Ext.os.is.Android2){fallbackProtocol='long-polling';}}else{fallbackProtocol=force_transport;}
oph_usepicker='auto';deviceType=localStorage.getItem('openHAB_device_type');if(deviceType&&deviceType!='Auto'){}
else{deviceType=Ext.os.deviceType;}
if(deviceType=="Phone"){deviceTypeCls='oph_phone';oph_usepicker=true;}else if(deviceType=="Tablet"){deviceTypeCls='oph_tablet';oph_usepicker=false;}else{deviceTypeCls='oph_desktop';oph_usepicker=false;}}
function getLanguage(){Ext.Ajax.request({url:'/CMD?ProservLanguage=xx',method:"GET",disableCaching:true,success:function(response){Ext.Ajax.request({url:'/rest/items/ProservLanguage/state',timeout:5000,success:function(response){ui_language=response.responseText;localStorage.setItem('openHAB_language',ui_language);},failure:function(response){alert('Error connecting to server!');}});},failure:function(response){title=OpenHAB.i18n_strings[ui_language].timeout;msg=OpenHAB.i18n_strings[ui_language].the_operation_timed_out_waiting;Ext.Msg.alert(title,msg);}});}
function getEmail(){Ext.Ajax.request({url:'/CMD?ProservEmail=?',method:"GET",disableCaching:true,success:function(response){Ext.Ajax.request({url:'/rest/items/ProservEmail/state',timeout:5000,success:function(response){g_email=response.responseText;},failure:function(response){alert('Error connecting to server!');}});},failure:function(response){title=OpenHAB.i18n_strings[ui_language].timeout;msg=OpenHAB.i18n_strings[ui_language].the_operation_timed_out_waiting;Ext.Msg.alert(title,msg);}});}
function getIP(){Ext.Ajax.request({url:'/CMD?ProservIP=?',method:"GET",disableCaching:true,success:function(response){Ext.Ajax.request({url:'/rest/items/ProservIP/state',timeout:5000,success:function(response){g_ip=response.responseText;},failure:function(response){alert('Error connecting to server!');}});},failure:function(response){title=OpenHAB.i18n_strings[ui_language].timeout;msg=OpenHAB.i18n_strings[ui_language].the_operation_timed_out_waiting;Ext.Msg.alert(title,msg);}});}
Ext.define('Oph.field.ButtonsSelect',{extend:'Ext.field.Field',xtype:'oph_buttons_selectfield',config:{cls:'x-buttons-field',styleHtmlContent:true,styleHtmlCls:'oph_none',labelWidth:'50%'},constructor:function(config){config=config||{};this.callParent([config]);},applyComponent:function(config){component=this;container=Ext.factory({styleHtmlContent:true,styleHtmlCls:'oph_right'},Ext.Container);if(Ext.isArray(this.config.options)){for(var i in this.config.options){item=container.add(Ext.create('Ext.Button',{cls:"x-button-normal oph_selection_btn",item:component.config.oph_item,command:component.config.options[i].command,text:this.config.options[i].label}));item.on({tap:function(){sendCommand(this.config.item,this.config.command)}});}}else{item=container.add(Ext.create('Ext.Button',{cls:"x-button-normal oph_selection_btn",item:component.config.oph_item,command:component.config.options.command,text:this.config.options.label}));item.on({tap:function(){sendCommand(this.config.item,this.config.command)}});}
return container;},initialize:function(){this.callParent();},setValueData:function(newValue){this.setLabel('<div class="'+icon_class+'" style="'+icon_style+'(/images/'+newValue.icon+'.png);"></div><div class="oph_label">'+newValue.label.replace(/[\[\]']+/g,'')+'</div>');if(Ext.isArray(newValue.mapping)){for(var i in newValue.mapping){this._component._items.items[i].removeCls('x-button-action');if(newValue.item.state==newValue.mapping[i].command){this._component._items.items[i].addCls('x-button-action');}}}else{this._component._items.items[0].addCls('x-button-action');}}});Ext.define('Oph.field.Slider',{extend:'Ext.field.Slider',xtype:'oph_sliderfield',config:{labelWidth:'50%'},constructor:function(config){config=config||{};this.callParent([config]);},initialize:function(){this.callParent();this.on({painted:function(component){component._component.element.on({tap:function(){sendCommand(component.config.oph_item,component.getValue())}});component._component.getThumb(0).element.on({dragend:function(){sendCommand(component.config.oph_item,component.getValue())}});}});},setValueData:function(newValue){if(newValue.item){this.setValue(newValue.item.state);}
this.setLabel('<div class="'+icon_class+'" style="'+icon_style+'(/images/'+newValue.icon+'.png);"></div><div class="oph_label">'+newValue.label.replace(/[\[\]']+/g,'')+'</div>');return this;}});Ext.define('Oph.field.Setpoint',{extend:'Ext.field.Spinner',xtype:'oph_setpointfield',config:{labelWidth:'50%'},constructor:function(config){config=config||{};this.callParent([config]);},initialize:function(){this.callParent();this.on({spindown:function(component,value){sendCommand(component.config.oph_item,value);},spinup:function(component,value){sendCommand(component.config.oph_item,value);},});},setValueData:function(newValue){if(newValue.item){if(newValue.item.state=='Uninitialized'){this.setValue(Number(this.config.minValue));}else{this.setValue(Number(newValue.item.state));}}
this.setLabel('<div class="'+icon_class+'" style="'+icon_style+'(/images/'+newValue.icon+'.png);"></div><div class="oph_label">'+newValue.label.replace(/[\[\]']+/g,'')+'</div>');return this;}});Ext.define('Oph.field.Select',{extend:'Ext.field.Select',xtype:'oph_selectfield',config:{displayField:'label',valueField:'command',labelWidth:'50%'},constructor:function(config){config=config||{};this.callParent([config]);},initialize:function(){this.callParent();this.on({painted:function(component){component.on({selected:function(){sendCommand(component.config.oph_item,component.getValue())}});}});},setValueData:function(newValue){if(newValue.item){this.setValue(newValue.item.state);}
this.setLabel('<div class="'+icon_class+'" style="'+icon_style+'(/images/'+newValue.icon+'.png);"></div><div class="oph_label">'+newValue.label.replace(/[\[\]']+/g,'')+'</div>');return this;},onListSelect:function(item,record){var me=this;if(record){me.setValue(record);this.fireEvent('selected',this);}},onPickerChange:function(picker,value){var me=this,currentValue=me.getValue(),newValue=value[me.getName()],store=me.getStore(),index=store.find(me.getValueField(),newValue);record=store.getAt(index);me.setValue(record);this.fireEvent('selected',this);},});Ext.define('Oph.field.Text',{extend:'Ext.field.Field',xtype:'oph_textfield',config:{cls:'x-textfield',styleHtmlContent:true,styleHtmlCls:'oph_none',labelWidth:'50%'},constructor:function(config){config=config||{};this.callParent([config]);},initialize:function(){this.callParent();},setValueData:function(newValue){this.setHtml(newValue.label.match(/\[(.*?)\]/)?newValue.label.match(/\[(.*?)\]/)[1]:newValue.label);this.setLabel('<div class="'+icon_class+'" style="'+icon_style+'(/images/'+newValue.icon+'.png);"></div><div class="oph_label">'+newValue.label.replace(/\[(.*?)\]/,'')+'</div>');return this;}});Ext.define('Oph.field.Toggle',{extend:'Ext.field.Toggle',xtype:'oph_togglefield',config:{labelWidth:'50%'},constructor:function(config){config=config||{};this.callParent([config]);},initialize:function(){this.callParent();this.on({painted:function(component){component._component.element.on({singletap:function(){sendCommand(component.config.oph_item,component.formatOutputValue(component.getValue()));}})
component._component.getThumb(0).element.on({dragend:function(){sendCommand(component.config.oph_item,component.formatOutputValue(component.getValue()))}});}});},setValueData:function(newValue){if(newValue.item){this.setValue(this.formatInputValue(newValue.item.state));}
this.setLabel('<div class="'+icon_class+'" style="'+icon_style+'(/images/'+newValue.icon+'.png);"></div><div class="oph_label">'+newValue.label.replace(/[\[\]']+/g,'')+'</div>');return this;},formatInputValue:function(value){if(value=="ON"){return 1;}else{return 0;}},formatOutputValue:function(value){if(value==1){return"ON";}else if(value==0){return"OFF";}}});function sendCommand(oph_item,value){if(oph_item){Ext.Ajax.request({comm_method:'ajax',url:'/rest/items/'+oph_item+'/',method:'POST',params:value,headers:{'Content-Type':'text/plain'},failure:function(){}});}}
Ext.define('Oph.field.Rollershutter',{extend:'Ext.field.Field',xtype:'oph_rollershutterfield',config:{cls:'x-rollershutter-field',styleHtmlContent:true,styleHtmlCls:'oph_none',labelWidth:'50%'},constructor:function(config){config=config||{};this.callParent([config]);},applyComponent:function(config){component=this;container=Ext.factory({styleHtmlContent:true,styleHtmlCls:'oph_right'},Ext.Container);but1=container.add(Ext.create('Ext.Button',{cls:"x-button-normal oph_rollershutter_btn",longPress:false,iconCls:'arrow_up',iconMask:true}));but1.element.item=component.config.oph_item;but1.element.on({touchstart:function(){sendCommand(this.item,"UP")},longpress:function(){but1.longPress=true},tap:function(){if(but1.longPress){but1.longPress=false;sendCommand(this.item,"STOP")}}});but2=container.add(Ext.create('Ext.Button',{cls:"x-button-normal oph_rollershutter_btn",iconCls:'delete',iconMask:true}));but2.element.item=component.config.oph_item;but2.element.on({tap:function(){sendCommand(this.item,"STOP")}});but3=container.add(Ext.create('Ext.Button',{cls:"x-button-normal oph_rollershutter_btn",longPress:false,iconCls:'arrow_down',iconMask:true}));but3.element.item=component.config.oph_item;but3.element.on({touchstart:function(){sendCommand(this.item,"DOWN")},longpress:function(){but3.longPress=true},tap:function(){if(but3.longPress){but3.longPress=false;sendCommand(this.item,"STOP")}}});return container;},initialize:function(){this.callParent();},initialize:function(){this.callParent();},setValueData:function(newValue){this.setLabel('<div class="'+icon_class+'" style="'+icon_style+'(/images/'+newValue.icon+'.png);"></div><div class="oph_label">'+newValue.label.replace(/[\[\]']+/g,'')+'</div>');return this;}});Ext.define('Oph.field.Button',{extend:'Ext.Button',xtype:'oph_buttonfield',isField:true,config:{style:'display:block',baseCls:'x-field oph_group_btn oph_button',labelCls:'',isField:true,cls:'oph_link'},constructor:function(config){config=config||{};this.callParent([config]);},initialize:function(){this.callParent();},setValueData:function(newValue){this.setHtml('<div class="'+icon_class+'" style="'+icon_style+'(/images/'+newValue.icon+'.png);"></div><div class="oph_label">'+newValue.label.replace(/[\[\]']+/g,'')+'</div><span class="arrow"></span>');return this;},getName:function(){return this.config.name;}});Ext.define('Oph.field.Webview',{extend:'Ext.Container',xtype:'oph_webviewfield',constructor:function(config){config=config||{};this.callParent([config]);var w_height=58*Number(config.oph_height);if(deviceType=='Phone'){w_height=52*Number(config.oph_height);}
this.setHeight(w_height+18);this.setStyle('position:relative;padding:0.4em;');this.setHtml('<div class="oph_webview_mask" style="z-index:999;position:absolute;top:0;left:0;width:100%;height:'+w_height+'px;"></div>  <div style="position:absolute;top:0;left:0;overflow:hidden;height:'+Number(w_height+20)+'px;width:100%;"><iframe scrolling="no" src="'+config.url+'" width="100%" height='+w_height+' style="border:1px solid gray;"></iframe></div>');},initialize:function(){this.callParent();},setValueData:function(newValue){}});Ext.define('Oph.field.Video',{extend:'Ext.Video',xtype:'oph_videofield',constructor:function(config){config=config||{};this.callParent([config]);if(config.url.substr(0,4)!="http"&&config.url.substr(0,1)!="/"){config.url="/"+config.url;}},initialize:function(){this.callParent();this.ghost.setHtml('<div style="text-align:center;padding-top:1em;">'+this.config.oph_label+'</div>');},setValueData:function(newValue){}});Ext.define('Oph.field.Chart',{extend:'Ext.Container',xtype:'oph_chartfield',refreshInterval:null,constructor:function(config){config=config||{};var chartType='items';if(config.oph_type=='GroupItem'){chartType='groups';}
config.img_src='/'+chart_servlet+'?'+chartType+'='+config.oph_item+'&period='+config.oph_period;this.callParent([config]);this.setHtml('<div style="width:100%;padding:0.4em;"><img id="img'+config.oph_id+'" src="'+config.img_src+'&random='+new Date().getTime()+'" style="width:100%;"></div>');},initialize:function(){this.callParent();this.on({painted:function(component){if(component.config.oph_refresh>0){component.config.refreshInterval=window.setInterval(function(){component.updateImage(component);},component.config.oph_refresh);}},erased:function(component){if(component.config.oph_refresh>0){window.clearInterval(component.config.refreshInterval);}}});},setValueData:function(newValue){},updateImage:function(container){Ext.fly('img'+container.config.oph_id).dom.src=container.config.img_src+'&random='+new Date().getTime();}});Ext.define('Oph.field.Image',{extend:'Ext.Container',xtype:'oph_imagefield',constructor:function(config){config=config||{};this.callParent([config]);if(config.url.substr(0,4)!="http"&&config.url.substr(0,1)!="/"){config.url="/"+config.url;}
this.setHtml('<div style="width:100%;padding:0.4em;"><img src="'+config.url+'" style="width:100%;"></div>');},initialize:function(){this.callParent();},setValueData:function(newValue){}});Ext.define('Oph.field.ImageLink',{extend:'Ext.Button',xtype:'oph_imagelink',config:{style:'display:block',baseCls:'none',labelCls:'',cls:'oph_link'},constructor:function(config){config=config||{};this.callParent([config]);if(config.url.substr(0,4)!="http"&&config.url.substr(0,1)!="/"){config.url="/"+config.url;}
this.setHtml('<div style="width:100%;padding:0.4em;"><img src="'+config.url+'" style="width:100%;"></div>');},initialize:function(){this.callParent();},setValueData:function(newValue){}});Ext.define('Oph.form.Panel',{extend:'Ext.Panel',xtype:'oph_formpanel',constructor:function(config){config=config||{};this.callParent([config]);},initialize:function(){this.callParent();},setValuesData:function(values){var fields=this.getFields(),name,field,value;values=values||{};for(name in values){if(values.hasOwnProperty(name)){field=fields[name];value=values[name];if(field){field.setValueData(value);}}}
return this;},getFields:function(byName){var fields={},itemName;var getFieldsFrom=function(item){if(item.isField){itemName=item.getName();if((byName&&itemName==byName)||typeof byName=='undefined'){if(fields.hasOwnProperty(itemName)){if(!Ext.isArray(fields[itemName])){fields[itemName]=[fields[itemName]];}
fields[itemName].push(item);}else{fields[itemName]=item;}}}
if(item.isContainer){item.items.each(getFieldsFrom);}};this.items.each(getFieldsFrom);return(byName)?(fields[byName]||[]):fields;},});function createSliderWidget(oph_item,oph_label,oph_icon){return{xtype:'oph_sliderfield',minValue:0,maxValue:100,oph_item:oph_item,label:'<div class="'+icon_class+'" style="'+icon_style+'(/images/'+oph_icon+'.png);"></div><div class="oph_label">'+oph_label.replace(/[\[\]']+/g,'')+'</div>'};}
function createTextWidget(oph_label,oph_icon){return{xtype:'oph_textfield',html:oph_label.match(/\[(.*?)\]/)?oph_label.match(/\[(.*?)\]/)[1]:oph_label,label:'<div class="'+icon_class+'" style="'+icon_style+'(/images/'+oph_icon+'.png);"></div><div class="oph_label">'+oph_label.replace(/\[(.*?)\]/,'')+'</div>'};}
function createToggleWidget(oph_item,oph_label,oph_icon){return{xtype:'oph_togglefield',oph_item:oph_item,label:'<div class="'+icon_class+'" style="'+icon_style+'(/images/'+oph_icon+'.png);"></div><div class="oph_label">'+oph_label.replace(/[\[\]']+/g,'')+'</div>'};}
function createRollershutterWidget(oph_item,oph_label,oph_icon){return{xtype:'oph_rollershutterfield',oph_item:oph_item,label:'<div class="'+icon_class+'" style="'+icon_style+'(/images/'+oph_icon+'.png);"></div><div class="oph_label">'+oph_label.replace(/[\[\]']+/g,'')+'</div>'};}
function createLinkWidget(data){page_label=data.label;if(data.linkedPage){page_id=data.linkedPage.id;}else{page_id="none";}
return{xtype:'oph_buttonfield',page_id:page_id,page_label:page_label}}
function createImageLinkWidget(url,page_id,page_label){return{xtype:'oph_imagelink',url:url,page_id:page_id,page_label:page_label,}}
function createSelectionWidget(oph_item,options,oph_label,oph_icon){return{xtype:'oph_selectfield',options:options,oph_item:oph_item,usePicker:oph_usepicker,label:'<div class="'+icon_class+'" style="'+icon_style+'(/images/'+oph_icon+'.png);"></div><div class="oph_label">'+oph_label.replace(/[\[\]']+/g,'')+'</div>'}};function createSetpointWidget(oph_item,oph_minvalue,oph_maxvalue,oph_step,oph_label,oph_icon){return{xtype:'oph_setpointfield',oph_item:oph_item,minValue:Number(oph_minvalue),maxValue:Number(oph_maxvalue),increment:Number(oph_step),defaultValue:oph_minvalue,cycle:false,label:'<div class="'+icon_class+'" style="'+icon_style+'(/images/'+oph_icon+'.png);"></div><div class="oph_label">'+oph_label.replace(/[\[\]']+/g,'')+'</div>'}};function createVideoWidget(oph_item,url,oph_label,oph_icon){return{xtype:'oph_videofield',oph_item:oph_item,url:url,width:'100%',height:'16em',style:'background-color:white;',posterUrl:'./app/video.png',oph_label:oph_label}};function createWebviewWidget(oph_item,url,oph_height,oph_label,oph_icon){return{xtype:'oph_webviewfield',oph_item:oph_item,url:url,width:'100%',height:'16em',oph_label:oph_label,oph_height:oph_height,}};function createButtonsWidget(oph_item,options,oph_label,oph_icon){return{xtype:'oph_buttons_selectfield',options:options,oph_item:oph_item,label:'<div class="'+icon_class+'" style="'+icon_style+'(/images/'+oph_icon+'.png);"></div><div class="oph_label">'+oph_label.replace(/[\[\]']+/g,'')+'</div>'}};function createUnsupportedWidget(){return{xtype:'field',label:'[UNSUPPORTED WIDGET]',};}
function createImageWidget(url){return{xtype:'oph_imagefield',url:url,cls:'x-image-field',};}
function createChartWidget(oph_item,oph_id,oph_w,oph_h,oph_period,oph_refresh,oph_type,oph_label,oph_icon){return{xtype:'oph_chartfield',oph_item:oph_item,oph_w:oph_w,oph_h:oph_h,oph_period:oph_period,oph_refresh:oph_refresh,oph_id:oph_id,oph_type:oph_type,img_src:''};}
var oph_app=Ext.application({name:'OpenHAB',icon:'/images/icon.png',tabletStartupScreen:'/images/splash-ipad-v.png',phoneStartupScreen:'/images/splash-iphone.png',glossOnIcon:false,launch:function(){setTheme();getOpenhabVersion();setProfile();getLanguage();getEmail();getIP();if(OpenHAB.usePictogramIcons==true){icon_class+=" oph_pictogram";icon_style="-webkit-mask-image:url";}
var sitemapUIpanel=Ext.create('Ext.Panel',{layout:{type:'card',},cls:'oph_background',fullscreen:true,id:'content',autoDestroy:true,items:[]});sitemapUIpanel.onAfter('activeitemchange',function(container,newcard,oldcard,opts){if(oldcard){oldcard.removeAll(true);oldcard.destroy();}
newcard.on({tap:tapHandler,delegate:'button'});},sitemapUIpanel);sitemapUIpanel.onBefore('activeitemchange',function(container,newcard,oldcard,opts){current_widgets=newcard.getFields();newcard.on({show:function(){var left_column_height=0;var right_column_height=0;var items=newcard.getItems();if(items.length==1){newcard.addCls('oph_widgets_container_one');}else{newcard.addCls('oph_widgets_container_many');}
for(var i=0;i<items.length;i++){if(left_column_height>right_column_height){right_column_height+=items.items[i].element.dom.clientHeight;items.items[i].addCls(deviceTypeCls+'_fieldset_right');}else{left_column_height+=items.items[i].element.dom.clientHeight;items.items[i].addCls(deviceTypeCls+'_fieldset_left');}}}});updateWidgetsAjax(broadCrumb[broadCrumb.length-1][0],'normal');},sitemapUIpanel);if(deviceType!="Phone"){transition={type:'fade',duration:500};leftNavPanel=sitemapUIpanel.add(new Ext.NestedList({docked:'left',width:'17em',scrollable:'auto',id:'leftPanel',styleHtmlContent:true,styleHtmlCls:'leftPanelContent',backText:OpenHAB.i18n_strings[ui_language].back,updateTitleText:false,store:leftPanelstore,listeners:{itemtap:NavBarItemTap,},getItemTextTpl:function(node){return'<tpl if="icon"><div class="'+icon_class+'" style="'+icon_style+'(/images/{icon}.png);"></div></tpl><div class="oph_label">{text}</div><span class="arrow"></span>';}}));leftNavPanel.doBack=function(me,node,lastActiveList,detailCardActive){broadCrumb.pop();if(UIobjects[broadCrumb[broadCrumb.length-1][0]].length>0){if(clickOnLeaf){me.getActiveItem().deselectAll();}else{this.goToNode(node.parentNode);}}else{this.goToNode(node.parentNode);}
clickOnLeaf=false;goToPage(broadCrumb[broadCrumb.length-1][0]);setCurrentLeftNavPage(broadCrumb[broadCrumb.length-1][0]);if(broadCrumb.length<=1){me.getBackButton().hide();}}}
sitemapUIpanel.add({docked:'top',xtype:'toolbar',ui:'light',items:[{id:'back_btn',ui:'back',text:OpenHAB.i18n_strings[ui_language].back,handler:backPage,hidden:true,},{xtype:'spacer'},{id:'title',xtype:'label',cls:'oph_title',centered:true,zIndex:0},{xtype:'spacer'},{id:'settings_btn',iconCls:'settings',iconMask:true,handler:showSettingsWindow}]});sitemap=localStorage.getItem('openHAB_sitemap');if(sitemap==''||sitemap==null||sitemap=='null'){sitemap='proserv';loadUIData(sitemap);}else if(sitemap=='choose'){sitemapsPanel=new Ext.Panel(sitemapsWindow);sitemapsPanel.setCls(deviceTypeCls+'_modal');Ext.Viewport.add(sitemapsPanel);}else{loadUIData(sitemap);}}});function setTitle(value){broadCrumb[broadCrumb.length-1][1]=value;refreshTitle();}
function refreshTitle(){if(deviceType=="Phone"){if(broadCrumb.length==1){Ext.getCmp('back_btn').hide();}else{Ext.getCmp('back_btn').show();}
broadCrumbText=broadCrumb[broadCrumb.length-1][1].replace(/[\[\]']+/g,'');}else{broadCrumbText='';for(var k in broadCrumb){broadCrumbText+=broadCrumb[k][1].replace(/[\[\]']+/g,'');if(k!=broadCrumb.length-1){broadCrumbText+=' > '}}}
Ext.getCmp('title').setHtml(broadCrumbText);}
function setCurrentLeftNavPage(value){currentLeftNavPage=value;}